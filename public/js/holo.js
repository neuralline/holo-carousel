!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).holo=e.holo||{})}(this,(function(e){"use strict";var t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function o(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var r,n={exports:{}};function i(){return r||(r=1,function(e){const o={reset:"[0m",magenta:"[35m",magentaBright:"[95m",red:"[31m",redBright:"[91m",green:"[32m",greenBright:"[92m",cyan:"[36m",cyanBright:"[96m",yellow:"[33m",yellowBright:"[93m",white:"[37m",whiteBright:"[97m",blue:"[34m",blueBright:"[94m",bgRed:"[41m",bgYellow:"[43m",bgBlue:"[44m",bold:"[1m",dim:"[2m",italic:"[3m",underline:"[4m"},r={DEBUG:["dim","cyan"],INFO:["blue","bold"],WARN:["yellowBright","bold"],ERROR:["redBright","bold"],SUCCESS:["greenBright","bold"]},n="undefined"!=typeof process&&process.versions&&process.versions.node,i="undefined"!=typeof window,a={DEBUG:0,INFO:1,WARN:2,ERROR:3,SUCCESS:1},s=(e,t,r)=>(s,c=!0,l=!1)=>{if(a[e]<a.DEBUG)return;const u=(d=e,m=s,`${c?`[${(new Date).toISOString()}]`:""} ${d}: ${m instanceof Error?`${m.message}\n${m.stack}`:"object"==typeof m?JSON.stringify(m,null,2):String(m)}`);var d,m;if(l||i){const t="ERROR"===e?"color: red; font-weight: bold":"WARN"===e?"color: orange; font-weight: bold":"SUCCESS"===e?"color: green; font-weight: bold":"INFO"===e?"color: blue":"color: gray";console[r](`%c${u}`,t)}else if(n){const e=t.reduce(((e,t)=>`${o[t]}${e}`),u);process.stdout.write(`${e}${o.reset}\n`)}},c={error:s("ERROR",r.ERROR,"error"),warn:s("WARN",r.WARN,"warn"),info:s("INFO",r.INFO,"log"),debug:s("DEBUG",r.DEBUG,"debug"),success:s("SUCCESS",r.SUCCESS,"log")},l=e=>{const t=new WeakMap;return(...o)=>{const r=o[0];return"object"==typeof r&&null!==r?(t.has(r)||t.set(r,e(...o)),t.get(r)):e(...o)}},u=(e,...t)=>t.reduce(((e,t)=>t(e)),e),d=(e,t)=>{if(Object.is(e,t))return!0;if("object"!=typeof e||"object"!=typeof t||null===e||null===t)return!1;if(Array.isArray(e)&&Array.isArray(t))return e.length===t.length&&e.every(((e,o)=>d(e,t[o])));const o=Object.keys(e),r=Object.keys(t);return o.length===r.length&&o.every((o=>d(e[o],t[o])))};"undefined"==typeof crypto&&(t.crypto={randomUUID:()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})),getRandomValues:e=>{if(null===e)return null;for(let t=0;t<e.length;t++)e[t]=Math.floor(256*Math.random());return e}});const m={RECUPERATION:6e4,MAX_TIMEOUT:Math.pow(2,31)-1},p="@cyre: System is offline",f="@cyre: System is online",g="@cyre: Welcome! How can I assist you?",h="Cannot add new channels: system is locked",y="Cannot add new subscribers: system is locked",v="Failed to prepare action: invalid configuration",b="Failed to execute action: runtime error",E="Action skipped: no payload changes detected",D="Failed to create channel: configuration error",S="Channel created successfully",w="Invalid channel data definition",k="Channel ID is required",I="Channel type is required",T="Invalid channel type specified",x="Invalid channel structure: check configuration",A="Invalid subscription parameters provided",O="Successfully subscribed to event",C="Invalid event handler provided",$="Subscription failed: check configuration",R="Call failed: system is offline",M="Call failed: invalid action ID",L="Call failed: action not responding",X="Dispatch failed: no subscriber found for this type",N="Q0.0U0.0A0.0N0.0T0.0U0.0M0 - I0.0N0.0C0.0E0.0P0.0T0.0I0.0O0.0N0.0S0-- ",_={MIN:50,BASE:200,MAX:1e3,RECOVERY:2e3},Y={HIGH:.9,CRITICAL:.95},U={MAX_CPU:80,MAX_MEMORY:85,MAX_EVENT_LOOP:50,MAX_CALL_RATE:1e3},H={system:{cpu:0,memory:0,eventLoop:0,isOverloaded:!1},breathing:{breathCount:0,currentRate:_.BASE,lastBreath:Date.now(),stress:0,isRecuperating:!1,recuperationDepth:0,pattern:"NORMAL",nextBreathDue:Date.now()+_.BASE},performance:{callsTotal:0,callsPerSecond:0,lastCallTimestamp:Date.now(),activeQueues:{critical:0,high:0,medium:0,low:0,background:0},queueDepth:0},stress:{cpu:0,memory:0,eventLoop:0,callRate:0,combined:0},lastUpdate:Date.now(),inRecuperation:!1,hibernating:!1,activeFormations:0,isLocked:!1},q=()=>{const e=new Map;return{get:t=>e.get(t),set:(t,o)=>{e.set(t,o),e.size>1e3&&Array.from(e.keys()).slice(0,e.size-1e3).forEach((t=>e.delete(t)))},forget:t=>e.delete(t),clear:()=>e.clear(),getAll:()=>Array.from(e.values()),size:()=>e.size}},B=q();B.set("quantum",H);const F=l(((e,t)=>{const o=Math.min(1,(e.cpu||0)/(.7*U.MAX_CPU)),r=Math.min(1,(e.memory||0)/(.7*U.MAX_MEMORY)),n=Math.min(1,(e.eventLoop||0)/(.7*U.MAX_EVENT_LOOP)),i=Math.min(1,(t.callsPerSecond||0)/(.7*U.MAX_CALL_RATE)),a=Math.max(o,r,n,i);return{cpu:o,memory:r,eventLoop:n,callRate:i,combined:Math.min(1,(o+r+n+i+2*a)/6)}})),P=e=>{if(e>=Y.CRITICAL)return _.RECOVERY;const t=Math.exp(e)-1;return Math.max(_.MIN,Math.min(_.MAX,_.BASE*(1+t)))},V={inRecuperation:!1,hibernating:!1,activeFormations:0,recuperationInterval:void 0,isLocked:!1,lock:()=>{V.isLocked=!0,V.update({isLocked:!0})},isSystemLocked:()=>V.isLocked,get:()=>{const e=B.get("quantum");return Object.freeze({...e,inRecuperation:V.inRecuperation,hibernating:V.hibernating,activeFormations:V.activeFormations})},update:e=>{const t={...B.get("quantum"),...e,lastUpdate:Date.now(),inRecuperation:e.inRecuperation??V.inRecuperation,hibernating:e.hibernating??V.hibernating,activeFormations:e.activeFormations??V.activeFormations};return(e.system||e.performance)&&(t.stress=F(t.system,t.performance)),B.set("quantum",t),t},updateBreath:e=>{const t=B.get("quantum"),o=F(e,t.performance),r=Date.now(),n={...t.breathing,breathCount:t.breathing.breathCount+1,lastBreath:r,stress:o.combined,currentRate:P(o.combined),nextBreathDue:r+P(o.combined),isRecuperating:o.combined>Y.HIGH,recuperationDepth:Math.min(1,o.combined),pattern:o.combined>Y.HIGH?"RECOVERY":"NORMAL"};return V.update({system:e,breathing:n,stress:o,inRecuperation:n.isRecuperating})},recordCall:(e="medium")=>{const t=B.get("quantum"),o=Date.now(),r=o-t.performance.lastCallTimestamp>=1e3?1:t.performance.callsPerSecond+1,n={...t.performance,callsTotal:t.performance.callsTotal+1,callsPerSecond:r,lastCallTimestamp:o,activeQueues:{...t.performance.activeQueues,[e]:t.performance.activeQueues[e]+1},queueDepth:t.performance.queueDepth+1};return V.update({performance:n})},isHealthy:()=>{const e=B.get("quantum");return!e.breathing.isRecuperating&&e.stress.combined<Y.HIGH},shouldAllowCall:e=>{const t=B.get("quantum");return t.breathing.isRecuperating?"critical"===e:t.stress.combined<Y.HIGH||"critical"===e||"high"===e},reset:()=>{V.inRecuperation=!1,V.hibernating=!1,V.activeFormations=0,V.isLocked=!1,B.set("quantum",H)},forget:e=>{B.forget(e)}},j=q(),z=q(),G=q(),W=q(),Q=q(),Z=e=>{const t=Q.get(e);t?.intervalId&&clearInterval(t.intervalId),Q.forget(e),W.forget(e)},J=e=>{if(!e?.id)throw new Error("IO must have an id");try{const t={...e,timestamp:Date.now(),type:e.type||e.id};Z(e.id),j.set(e.id,t),Q.set(e.id,{lastExecutionTime:Date.now(),executionCount:0,errors:[]}),e.detectChanges&&W.set(e.id,e.payload),V.recordCall(e.priority?.level)}catch(t){throw c.error(`Failed to set IO: ${t instanceof Error?t.message:String(t)}`),t}},K=e=>j.get(e),ee=e=>(Z(e),j.forget(e)),te=()=>{j.getAll().forEach((e=>{e.id&&Z(e.id)})),W.clear(),Q.clear(),j.clear(),V.reset()},oe=(e,t)=>{const o=W.get(e);return!d(t,o)},re=e=>W.get(e),ne=e=>Q.get(e),ie=e=>{if(!e?.id||!e?.fn)throw new Error("Invalid subscriber format");z.set(e.id,e)},ae=e=>z.get(e),se=()=>z.clear(),ce=e=>{e.id&&G.set(e.id,e)},le=e=>G.get(e),ue=e=>{const t=G.get(e);return t?.timeoutId&&clearTimeout(t.timeoutId),G.forget(e)},de=()=>{G.getAll().forEach((e=>{e.timeoutId&&clearTimeout(e.timeoutId)})),G.clear()},me=()=>G.getAll(),pe=()=>G.getAll().filter((e=>"active"===e.status)),fe=e=>e.type&&e.id?{...e,ok:!0,status:"active"}:{...e,ok:!1,done:!1,status:"error",error:"Missing required fields: type or id"},ge=e=>e.detectChanges?oe(e.id,e.payload)?e:{...e,ok:!0,done:!0,status:"skipped",skipped:!0,skipReason:E}:e,he=e=>{if(e.skipped||"error"===e.status)return e;try{const t=ae(e.id);if(!t)throw new Error("No subscriber found");const o=t.fn(e.payload);return o&&"object"==typeof o&&"id"in o?{...e,ok:!0,done:!0,status:"completed",intraLink:{id:o.id,payload:o.payload}}:{...e,ok:!0,done:!0,status:"completed"}}catch(t){return c.error(`${b}: ${e}, Error: ${t instanceof Error?t.message:String(t)}`),{...e,ok:!1,done:!1,status:"error",error:t instanceof Error?t.message:String(t)}}},ye=(e,t)=>{if(!e)return c.error(v),{id:"",type:"",ok:!1,done:!1,status:"error",error:v};try{return u((e=>{try{if(!e)throw new Error(v);return{...e,ok:!0,done:!1,status:"pending",timestamp:Date.now()}}catch(t){return{id:"",type:"",ok:!1,done:!1,status:"error",error:v}}})(e),fe,ge,he,(e=>{return"error"===e.status?e:((t=e).log&&("error"===t.status?c.error(t):(t.status,c.info(t))),t);var t}),(e=>{return"error"===e.status?e:((t=e).ok&&!t.skipped&&J({...t,timestamp:Date.now()}),t);var t}))}catch(o){return c.error(`Action processing failed: ${o}`),{...e,ok:!1,done:!1,status:"error",error:o instanceof Error?o.message:String(o)}}},ve=l((e=>e?e.id?e.type||e.id?e.type&&"string"!=typeof e.type?{isValid:!1,error:T}:{isValid:!0}:{isValid:!1,error:I}:{isValid:!1,error:k}:{isValid:!1,error:x})),be=(e,t)=>{try{if(!("object"==typeof(n=e)&&null!==n&&"id"in n&&"string"==typeof n.id&&n.id.length>0))return c.error(x),{ok:!1,message:x};const i=ve(e);if(!i.isValid)return c.error(i.error),{ok:!1,message:i.error};if(o=e,(r=t)&&!Object.entries(r).filter((([e,t])=>t(void 0).required)).map((([e])=>e)).every((e=>e in o)))return c.error(w),{ok:!1,message:w};const a=((e,t)=>{try{const o={...e},r=[];for(const[n,i]of Object.entries(e)){const e=t[n];if(!e){o[n]=i;continue}const a=e(i);if(!a.ok){if(a.required)return{ok:!1,message:`Required field '${n}' validation failed: ${a.message}`,payload:o};r.push(`${n}: ${a.message}`)}o[n]=a.payload}for(const[n,i]of Object.entries(t))if(i(void 0).required&&!(n in e))return{ok:!1,message:`Missing required field: ${n}`,payload:o};return r.length>0?{ok:!1,message:r.join("; "),payload:o}:{ok:!0,payload:o}}catch(o){const e=o instanceof Error?o.message:String(o);return c.error(`Data definition processing failed: ${e}`),{ok:!1,message:w}}})(e,t);if(!a.ok)return a;const s=(e=>{const t=Date.now();return{...e,type:e.type||e.id,timestamp:t,interval:e.interval||0,timeOfCreation:e.timeOfCreation||t}})({...a.payload,id:e.id});return c.success(S),{ok:!0,message:S,payload:s}}catch(i){const e=i instanceof Error?i.message:String(i);return c.error(`Channel processing failed: ${e}`),{ok:!1,message:D}}var o,r,n},Ee=(e,t)=>{try{const n=(r=t,(o=e)&&"string"==typeof o?"function"!=typeof r?{ok:!1,message:C,error:{code:"INVALID_HANDLER",message:"Event handler must be a function"}}:{ok:!0,message:O,subscriber:{id:o.trim(),fn:r}}:{ok:!1,message:T,error:{code:"INVALID_TYPE",message:`Type must be a non-empty string, received: ${o}`}});if(!n.ok||!n.subscriber)return c.error(n.error||n.message),{ok:!1,message:n.message};const{subscriber:i}=n;if(ae(i.id)){const e=`DUPLICATE LISTENER DETECTED: Channel "${i.id}" already has a listener attached!`;c.warn(e),"undefined"!=typeof console&&console.warn&&(console.warn(`ðŸ”¥ ${e}`),console.warn("This may cause unexpected behavior if the previous listener is still active."),console.warn("Consider using cyre.forget() to remove previous listeners before adding new ones."))}return ie(i),c.info(`${O}: ${i.id}`),{ok:!0,message:`${O}: ${i.id}`}}catch(n){const e=n instanceof Error?n.message:String(n);return c.error(`Failed to add subscriber: ${e}`),{ok:!1,message:$}}var o,r},De=(e,t)=>V.isSystemLocked()?(c.error(y),{ok:!1,message:y}):Array.isArray(e)?(e=>{try{const t=e.map((e=>{if(!e.id||!e.fn)return c.error(`Invalid subscriber format: ${JSON.stringify(e)}`),!1;try{return ie(e),!0}catch(t){return c.error(`Failed to add subscriber ${e.id}: ${t}`),!1}})).filter(Boolean).length,o=e.length;return 0===t?{ok:!1,message:`Failed to add any subscribers out of ${o}`}:{ok:!0,message:`Successfully added ${t} out of ${o} subscribers`}}catch(t){const e=t instanceof Error?t.message:String(t);return c.error(`Batch subscription failed: ${e}`),{ok:!1,message:$}}})(e):"string"==typeof e&&t?Ee(e,t):(c.error(A),{ok:!1,message:A}),Se=async e=>{if(!e||!e.id)return;const t=performance.now(),o=le(e.id);var r;if(o&&o.isActive)try{await e.callback();const n=performance.now()-t;o.metrics.totalExecutions++,o.metrics.successfulExecutions++,o.metrics.lastExecutionTime=n,o.metrics.longestExecutionTime=Math.max(o.metrics.longestExecutionTime,n),o.metrics.shortestExecutionTime=Math.min(o.metrics.shortestExecutionTime,n),o.metrics.averageExecutionTime=(o.metrics.averageExecutionTime*(o.metrics.totalExecutions-1)+n)/o.metrics.totalExecutions,o.executionCount++,o.lastExecutionTime=Date.now(),"number"==typeof o.repeat&&o.repeat>0&&(o.repeat=o.repeat-1),ce(o),!0===(r=o.repeat)||r===1/0||"number"==typeof r&&r>0?ke(o):ue(o.id)}catch(n){const t=le(e.id);t&&(t.metrics.failedExecutions++,ce(t)),c.error(`Timer execution failed: ${n}`)}},we=e=>{if(!e||!e.id)return;const t=e.duration>m.RECUPERATION?m.RECUPERATION:Math.max(e.duration/10,1e3);let o,r=Date.now();const n=()=>{const i=le(e.id);if(!i||!i.isActive)return void clearTimeout(o);const a=Date.now(),s=V.get(),c=1+(s.stress?.combined||0);if(a-r>t||Math.abs(c-1)>.1){const e=i.originalDuration-i.executionCount*m.MAX_TIMEOUT;i.duration=Math.min(e,m.MAX_TIMEOUT)*c,i.nextExecutionTime=a+i.duration,ce(i),r=a}s.hibernating||"active"!==i.status||(o=setTimeout(n,t),i.recuperationInterval=o,ce(i))};return o=setTimeout(n,t),o},ke=e=>{if(!e||!e.id)return;const t=V.get();if(t.hibernating)return;const o=Date.now(),r=1+(t.stress?.combined||0),n=le(e.id);if(!n||!n.isActive)return;if(n.executionCount>1e4)return c.error("Maximum execution count exceeded"),void ue(n.id);let i=n.duration*r;if(n.isInRecuperation){const e=n.originalDuration-n.executionCount*m.MAX_TIMEOUT;i=Math.min(e*r,m.MAX_TIMEOUT),n.duration=i,n.duration>m.RECUPERATION&&(n.recuperationInterval&&clearTimeout(n.recuperationInterval),n.recuperationInterval=we(n)),e<=m.MAX_TIMEOUT&&(n.isInRecuperation=!1)}else n.duration=i;n.nextExecutionTime=o+n.duration,n.timeoutId&&clearTimeout(n.timeoutId);const a="undefined"!=typeof process&&"test"===process.env.NODE_ENV;n.timeoutId=a?setTimeout((()=>Se(n)),n.duration):n.duration<25?((e,t)=>{if("undefined"!=typeof process&&"test"===process.env.NODE_ENV)return setTimeout(e,t);const o=process.hrtime(),r=()=>{const[n,i]=process.hrtime(o),a=1e3*n+i/1e6;if(a>=t)e();else{const e=t-a;e<1?setImmediate(r):e<25?setTimeout(r,0):setTimeout(r,Math.floor(e/2))}};return setTimeout(r,0)})((()=>Se(n)),n.duration):setTimeout((()=>Se(n)),n.duration),ce(n)},Ie=(e,t,o,r=crypto.randomUUID())=>{try{const i=((e,t,o,r)=>{if(!e||"number"!=typeof t||"function"!=typeof o)throw new Error("Invalid formation parameters");const n=Date.now(),i=t>=m.MAX_TIMEOUT,a=V.get(),s=1+(a.stress?.combined||0),c={id:e,startTime:n,duration:i?m.MAX_TIMEOUT:t*s,originalDuration:t,callback:o,repeat:r,executionCount:0,lastExecutionTime:0,nextExecutionTime:n+(i?m.MAX_TIMEOUT:t*s),isInRecuperation:i,status:"active",isActive:!0,metrics:{totalExecutions:0,successfulExecutions:0,failedExecutions:0,averageExecutionTime:0,lastExecutionTime:0,longestExecutionTime:0,shortestExecutionTime:1/0,missedExecutions:0}};return i&&(c.recuperationInterval=we(c)),c})(r,"number"==typeof e?e:24*((n=e).days||0)*60*60*1e3+60*(n.hours||0)*60*1e3+60*(n.minutes||0)*1e3+1e3*(n.seconds||0)+(n.milliseconds||0),t,o);return ce(i),ke(i),{kind:"ok",value:i}}catch(i){return{kind:"error",error:i instanceof Error?i:new Error("Timer creation failed")}}var n},Te=e=>{const t=le(e);t?.timeoutId&&clearTimeout(t.timeoutId),t?.recuperationInterval&&clearTimeout(t.recuperationInterval),ue(e)},xe=e=>{if(e){const t=le(e);t&&(t.timeoutId&&clearTimeout(t.timeoutId),t.recuperationInterval&&clearTimeout(t.recuperationInterval),t.status="paused",t.isActive=!1,ce(t))}else me().forEach((e=>{e.timeoutId&&clearTimeout(e.timeoutId),e.recuperationInterval&&clearTimeout(e.recuperationInterval),e.status="paused",e.isActive=!1,ce(e)}))},Ae=e=>{if(!V.get().hibernating)if(e){const t=le(e);t&&"paused"===t.status&&(t.status="active",t.isActive=!0,ce(t),ke(t))}else me().forEach((e=>{"paused"===e.status&&(e.status="active",e.isActive=!0,ce(e),ke(e))}))},Oe=()=>{V.update({hibernating:!0}),me().forEach((e=>{e.timeoutId&&clearTimeout(e.timeoutId),e.recuperationInterval&&clearTimeout(e.recuperationInterval)})),de()},Ce={id:(e="")=>"string"==typeof e?{ok:!0,payload:e}:{ok:!1,payload:null,message:`action.id must be a string. Received '${e}'`,required:!0},type:(e="")=>"string"==typeof e?{ok:!0,payload:e}:{ok:!1,payload:null,message:`action.type must be a string. Received '${e}'`,required:!0},payload:(e=null)=>({ok:!0,payload:e}),interval:(e=0)=>Number.isInteger(e)?{ok:!0,payload:e}:{ok:!1,payload:0,message:`'${e}' invalid action.interval value`,required:!1},timeOfCreation:(e=0)=>Number.isInteger(e)?{ok:!0,payload:e}:{ok:!1,payload:0,message:`'${e}' invalid @cyre.call time of creation value`,required:!0},repeat:(e=0)=>"number"==typeof e||"boolean"==typeof e||e===1/0?{ok:!0,payload:e}:{ok:!1,payload:0,message:`'${e}' invalid action.repeat value. Expected number, boolean, or Infinity.`,required:!1},message:(e="")=>"string"==typeof e?{ok:!0,payload:e}:{ok:!1,payload:"",message:`action.message must be a string. Received '${e}'`,required:!1},group:(e="")=>"string"==typeof e?{ok:!0,payload:e}:{ok:!1,payload:null,message:`'${e}' invalid action.group value`,required:!1},callback:(e="")=>"string"==typeof e?{ok:!0,payload:e}:{ok:!1,payload:null,message:`'${e}' invalid action.callback value`,required:!1},log:(e=!1)=>"boolean"==typeof e?{ok:!0,payload:e}:{ok:!1,payload:!1,message:`'${e}' invalid action.log value`,required:!1},middleware:(e="")=>"string"==typeof e?{ok:!0,payload:e}:{ok:!1,payload:null,message:`'${e}' invalid action.middleware value`,required:!1},throttle:(e=0)=>Number.isInteger(e)?{ok:!0,payload:e}:{ok:!1,payload:100,message:`'${e}'  action.throttle value must be a number`,required:!1},debounce:(e=0)=>Number.isInteger(e)?{ok:!0,payload:e}:{ok:!1,payload:100,message:`'${e}'  action.debounce value must be a number`,required:!1},at:(e=0)=>({ok:!1,payload:e,message:`'${e}'  action.at is an experimental feature, not applied yet`,required:!1})},$e=function(e=crypto.randomUUID()){let t=!1;const o=async(e,t,o)=>{const r=e.repeat,i=Ie(t,(async()=>{V.isHealthy()&&await n({...e,timeOfCreation:performance.now(),payload:o??e.payload})}),r,e.id);return"error"===i.kind?{ok:!1,payload:null,message:i.error.message}:{ok:!0,payload:null,message:`Scheduled with breathing-adjusted interval: ${Math.round(t)}ms. First execution will occur after this interval.`}},r=async(e,t)=>{const o=e.priority?.level||"medium";if(!V.shouldAllowCall(o)){const{stress:e}=V.get();return{ok:!1,payload:null,message:`System under high stress (${(100*e.combined).toFixed(1)}%). Try later.`}}return i(e,t)},n=async e=>{if(!e?.type)throw new Error("Invalid IO object");try{const o=ae(e.type)||ae(e.id);if(!o){const t=`${X} ${e.type}`;return c.error(t),{ok:!1,payload:null,message:t}}const r=performance.now(),n=ye({...e},o.fn);if(e.log&&c.info({...n,executionTime:performance.now()-r,timestamp:Date.now()}),n?.intraLink)try{const{id:e,payload:t}=n.intraLink;await a(e,t)}catch(t){c.error(`Linked action error: ${t}`)}return{ok:!0,payload:n,message:g}}catch(t){const e=t instanceof Error?t.message:String(t);return c.error(`Dispatch error: ${e}`),{ok:!1,payload:null,message:`Dispatch error: ${e}`}}},i=async(e,t)=>{try{if(e.throttle){const t=Date.now()-(ne(e.id)?.lastExecutionTime||0);if(t<e.throttle)return{ok:!1,payload:null,message:`Throttled: ${e.throttle-t}ms remaining`}}if(e.debounce){e.debounceTimerId&&(Te(e.debounceTimerId),e.debounceTimerId=void 0);const o=`${e.id}-debounce-${Date.now()}`,r=t??e.payload,i=Ie(e.debounce,(async()=>{await n({...e,timeOfCreation:performance.now(),payload:r,debounceTimerId:void 0}),V.recordCall(e.priority?.level)}),!1,o);return"ok"===i.kind?(e.debounceTimerId=o,J(e),{ok:!0,payload:null,message:`Debounced: will execute after ${e.debounce}ms`}):{ok:!1,payload:null,message:`Failed to setup debounce: ${i.error.message}`}}const o=await n({...e,timeOfCreation:performance.now(),payload:t??e.payload});return V.recordCall(e.priority?.level),o}catch(o){return{ok:!1,payload:null,message:`Call failed: ${o instanceof Error?o.message:String(o)}`}}},a=async(e,n)=>{if(t)return{ok:!1,message:R,payload:null};if(!e?.trim())return{ok:!1,message:M,payload:null};const a=K(e.trim());return a?(async(e,t)=>{if(!e)return{ok:!1,payload:null,message:"Invalid action"};const{breathing:n,stress:a}=V.get();if(n.isRecuperating&&"critical"!==e.priority?.level)return{ok:!1,payload:null,message:`System recuperating (${(100*n.recuperationDepth).toFixed(1)}% depth). Try later.`};if(e.interval){const r=e.interval*(1+a.combined);return o(e,r,t)}return a.combined>=Y.HIGH?r(e,t):i(e,t)})(a,n):{ok:!1,payload:null,message:`${L}: ${e}`}},s=()=>{if(!t)try{me().forEach((e=>{e.timeoutId&&clearTimeout(e.timeoutId)})),Oe(),se(),te(),V.reset(),t=!0,"undefined"!=typeof process&&process.exit&&process.exit(0)}catch(e){c.error(`Failed to shutdown gracefully: ${e}`),"undefined"!=typeof process&&process.exit&&process.exit(1)}};return"undefined"!=typeof window?window.addEventListener("beforeunload",s):(process.on("SIGINT",s),process.on("SIGTERM",s),process.on("uncaughtException",(e=>{console.error("Uncaught Exception:",e),s()}))),{initialize:()=>(t=!1,Ie(_.BASE,(async()=>{const e=V.get();V.updateBreath({cpu:e.system.cpu,memory:e.system.memory,eventLoop:e.system.eventLoop,isOverloaded:e.system.isOverloaded})}),!0),Ae(),console.log("%c"+N,"background: rgb(151, 2, 151); color: white; display: block;"),{ok:!0,payload:200,message:g}),call:a,action:e=>{if(t)c.error(p);else if(V.isLocked)c.error(h);else try{if(Array.isArray(e))e.forEach((e=>{const t=be({...e,type:e.type||e.id},Ce);t.ok&&t.payload&&J(t.payload)}));else{const t=be({...e,type:e.type||e.id},Ce);t.ok&&t.payload&&J(t.payload)}}catch(o){c.error(`Action registration failed: ${o}`)}},on:De,shutdown:s,lock:()=>t?{ok:!1,message:R,payload:null}:(V.isLocked=!0,c.info("Cyre system locked - no new channels or subscribers can be added"),{ok:!0,message:"System locked successfully",payload:null}),status:()=>(t?c.info({ok:!0,message:p}):c.info({ok:!0,message:f}),t),forget:e=>t?(c.error(R),!1):(xe(e),ee(e)),get:e=>{if(!t)return K(e);c.error(R)},pause:e=>{if(t)return void c.error(R);xe(e);const o=me();if(e){const t=le(e);t&&ce({...t,status:"paused"})}else o.forEach((e=>{e&&ce({...e,status:"paused"})}))},resume:e=>{if(t)return void c.error(R);Ae(e);const o=me();if(e){const t=le(e);t&&ce({...t,status:"active"})}else o.forEach((e=>{e&&ce({...e,status:"active"})}))},hasChanged:(e,o)=>t?(c.error(R),!1):oe(e,o),getPreviousPayload:e=>{if(!t)return re(e);c.error(R)},getBreathingState:()=>V.get().breathing,getPerformanceState:()=>{const e=V.get();return{totalProcessingTime:0,totalCallTime:0,totalStress:e.stress.combined,stress:e.stress.combined}},getMetrics:e=>t?{hibernating:!0,activeFormations:0,inRecuperation:!1,breathing:V.get().breathing,formations:[]}:{hibernating:!1,activeFormations:pe().length,inRecuperation:!1,breathing:V.get().breathing,formations:me().filter((t=>t.id===e)).map((e=>({...e,breathingSync:1})))}}},Re=$e("quantum-inceptions");Re.initialize(),e.Cyre=$e,e.CyreLog=c,e.cyre=Re,e.default=Re,e.isEqual=d,e.memoize=l,e.pipe=u,e.tryCatch=async e=>{try{return{kind:"ok",value:await e()}}catch(t){return{kind:"error",error:t instanceof Error?t:new Error(String(t))}}},e.version="3.1.2",Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}(n.exports)),n.exports}const a=o(i()),s=e=>({id:e,enabled:1,wheel:0,controller:0,drag:1,swipe:1,snap:1,focus:1,animate:0,animateDirection:1,duration:0,loop:200,orientation:0,active:!0,onClick:!0,onDoubleClick:!0}),c=(()=>{let e={instances:{}};return{getInstance:t=>e.instances[t]?{...e.instances[t]}:void 0,getAllInstances:()=>({...e.instances}),getVirtualDom:t=>e.instances[t]?{...e.instances[t].virtualDom}:void 0,getDom:t=>e.instances[t]?{...e.instances[t].Dom}:void 0,getDimensions:t=>{const o=e.instances[t];if(o)return{car:{w:o.Dom.width||0,h:o.Dom.height||0},con:{w:o.virtualDom.container.width||0,h:o.virtualDom.container.height||0,x:o.virtualDom.transformX,y:o.virtualDom.transformY,z:o.virtualDom.transformZ}}},setDimension:t=>{const o=e.instances[t];if(!o)return;const{virtualDom:r,Dom:n}=o;r.io.orientation?n.carousel.style.height=`${r.carousel.height}px`:n.carousel.style.width=`${r.carousel.width}px`},registerInstance:(t,o,r={})=>{const n=(e=>({id:e,carousel:{},container:{},io:s(e),title:null,description:null,duration:600,transitionTiming:"cubic-bezier(0.215, 0.61, 0.355, 1)",transformX:0,transformY:0,transformZ:0,numberOfSlots:0,endOfSlide:0,endOfSlidePosition:0,item:{max:8}}))(t);n.io={...n.io,...r};const i={id:t,virtualDom:n,Dom:{carousel:o.carousel,container:o.container},touchState:{pressed:!1,positionX:0,positionY:0,currentX:0,currentY:0,multiplier:1.482},updateStyle:!1};return e={...e,instances:{...e.instances,[t]:i}},{...i}},updateInstance:(t,o)=>{if(!e.instances[t])return;const r={...e.instances[t],...o,virtualDom:o.virtualDom?{...e.instances[t].virtualDom,...o.virtualDom}:e.instances[t].virtualDom,Dom:o.Dom?{...e.instances[t].Dom,...o.Dom}:e.instances[t].Dom,touchState:o.touchState?{...e.instances[t].touchState,...o.touchState}:e.instances[t].touchState};return e={...e,instances:{...e.instances,[t]:r}},{...r}},updateVirtualDom:(t,o)=>{if(!e.instances[t])return;const r={...e.instances[t].virtualDom,...o,carousel:o.carousel?{...e.instances[t].virtualDom.carousel,...o.carousel}:e.instances[t].virtualDom.carousel,container:o.container?{...e.instances[t].virtualDom.container,...o.container}:e.instances[t].virtualDom.container,io:o.io?{...e.instances[t].virtualDom.io,...o.io}:e.instances[t].virtualDom.io,item:o.item?{...e.instances[t].virtualDom.item,...o.item}:e.instances[t].virtualDom.item};return e={...e,instances:{...e.instances,[t]:{...e.instances[t],virtualDom:r}}},{...r}},updateDom:(t,o)=>{if(!e.instances[t])return;const r={...e.instances[t].Dom,...o};return e={...e,instances:{...e.instances,[t]:{...e.instances[t],Dom:r}}},{...r}},updateTouchState:(t,o)=>{if(!e.instances[t])return;const r={...e.instances[t].touchState,...o};return e={...e,instances:{...e.instances,[t]:{...e.instances[t],touchState:r}}},{...r}},updateStyle:(t,o)=>{e.instances[t]&&(e={...e,instances:{...e.instances,[t]:{...e.instances[t],updateStyle:o}}})},applyDomTransform:t=>{const o=e.instances[t];o&&(o.updateStyle?(o.Dom.container.style.transitionDuration=o.virtualDom.duration+"ms",o.Dom.container.style.transitionTimingFunction=o.virtualDom.transitionTiming):(o.Dom.container.style.transitionDuration="0ms",o.Dom.container.style.transitionTimingFunction="linear"),o.Dom.container.style.transform=`translate3d(${o.virtualDom.transformX}px, ${o.virtualDom.transformY}px, ${o.virtualDom.transformZ}px)`)},removeInstance:t=>{if(!e.instances[t])return!1;const{[t]:o,...r}=e.instances;return e={...e,instances:r},!0},hasInstance:t=>!!e.instances[t]}})(),l="refresh carousel",u="refresh screen",d="SNAP",m="SHAKE",p="Animate",f="AnimateForward",g="AnimateBackward",h="nxtSlide",y="prvSlide",v="firstSlide",b="lastSlide",E="activate",D="wheeler",S="holo-error",w=(e,t)=>Math.round(e/t)*t,k=([e,t])=>{const o=t.id,r={...t,transformX:-Math.abs(e.offsetLeft)};c.updateVirtualDom(o,r),a.call(d,r),e.classList.add("active")},I=e=>{const t=e.id;if(1===e.endOfSlide)return;const o={...e,transformX:e.transformX+(e.carousel.width||0),transformY:e.transformY+(e.carousel.height||0)};c.updateVirtualDom(t,o),a.call(d,o)},T=e=>{const t=e.id;if(-1===e.endOfSlide)return;const o={...e,transformX:e.transformX-(e.carousel.width||0),transformY:e.transformY-(e.carousel.height||0)};c.updateVirtualDom(t,o),a.call(d,o)},x=e=>{const t=e.id,o={...e,transformX:0,transformY:0,endOfSlide:1};c.updateVirtualDom(t,o),a.call(d,o)},A=e=>{const t=e.id,o={...e,transformX:e.endOfSlidePosition,transformY:e.endOfSlidePosition,endOfSlide:-1};c.updateVirtualDom(t,o),a.call(d,o)},O=e=>-1===e.endOfSlide?a.call(v,e):a.call(h,e),C=e=>1===e.endOfSlide?a.call(b,e):a.call(y,e),$=e=>{a.call(f)},R=(e,t)=>{e.preventDefault();const o=c.getVirtualDom(t);if(!o)return a.call(S,"@Wheeler virtual dom undefined");e.deltaY<0?a.call(y,o):e.deltaY>0&&a.call(h,o)},M=e=>{const t={...e};return t.transformY=t.io.snap?w(t.transformY,t.item.height||0):t.transformY,t.transformX=0,t.transformY>=0?(t.transformY=0,t.endOfSlide=1):t.transformY<=t.endOfSlidePosition?(t.transformY=t.endOfSlidePosition,t.endOfSlide=-1):t.endOfSlide=0,t},L={},X=e=>{const t=c.getInstance(e);if(!t||!t.touchState.pressed)return;const{touchState:o,virtualDom:r}=t,n=o.positionX-o.currentX,i=(e=>{const t={...e};return t.transformY=0,t.transformX>=0?t.transformX=0:t.transformX<=t.endOfSlidePosition&&(t.transformX=t.endOfSlidePosition),t})({...r,transformX:(o.snapShotWidth||0)-n*o.multiplier});c.updateVirtualDom(e,i),c.updateTouchState(e,{distance:n}),c.applyDomTransform(e),t.touchState.pressed&&(L[e]=requestAnimationFrame((()=>X(e))))},N=e=>{const t=c.getInstance(e);if(!t||!t.touchState.pressed)return;const{touchState:o,virtualDom:r}=t,n=o.positionY-o.currentY,i=(o.snapShotHeight||0)-n*o.multiplier,a=M({...r,transformY:i});c.updateVirtualDom(e,a),c.updateTouchState(e,{distance:n}),c.applyDomTransform(e),t.touchState.pressed&&(L[e]=requestAnimationFrame((()=>N(e))))},_=e=>{const t=c.getAllInstances();let o=null;for(const a in t)if(t[a].touchState.pressed){o=a;break}if(!o)return;const r=c.getInstance(o);if(!r)return;e.preventDefault(),L[o]&&(cancelAnimationFrame(L[o]),delete L[o]),c.updateTouchState(o,{pressed:!1});const{touchState:n,virtualDom:i}=r,s=performance.now()-(n.TouchStartTimeStamp||0),l=((e,t)=>e/t)(n.distance||0,s);l>1.2?a.call(h,i):l<-1.2?a.call(y,i):(e=>e<250)(s)?Y(e,o):a.call(d,i)},Y=(e,t)=>{const o=e.target.closest("li.holo");if(!o)return a.call(S,"_focus holo item not found");const r=c.getInstance(t);return r?(r.touchState.targetHoloComponent&&r.touchState.targetHoloComponent.classList.remove("active"),c.updateTouchState(t,{targetHoloComponent:o}),a.call(E,[o,r.virtualDom]),!0):a.call(S,"_focus holo instance not found")},U={_touchStart:(e,t)=>{if(!t)return void a.call(S,"@_touchStart: missing carousel ID");const o=c.getInstance(t);if(!o)return void a.call(S,"@_touchStart: undefined getInstance fro: "+t);L[t]&&(cancelAnimationFrame(L[t]),delete L[t]);const r="touches"in e?e.touches[0].clientX:e.clientX,n="touches"in e?e.touches[0].clientY:e.clientY,i={pressed:!0,positionX:r,positionY:n,currentX:r,currentY:n,TouchStartTimeStamp:performance.now(),multiplier:1.482,snapShotWidth:o.virtualDom.transformX||0,snapShotHeight:o.virtualDom.transformY||0};c.updateTouchState(t,i),c.updateStyle(t,!1),o.virtualDom.io.orientation?(N(t),e.preventDefault()):(X(t),e.preventDefault())},_touchEnd:_,_dragScrollHorizontal:X,_dragScrollVertical:N,_focus:Y,setupGlobalTouchListeners:()=>{const e=e=>{const t=c.getAllInstances();for(const o in t)t[o].touchState.pressed&&c.updateTouchState(o,{currentX:e.clientX,currentY:e.clientY})},t=e=>{const t=c.getAllInstances();for(const o in t)t[o].touchState.pressed&&c.updateTouchState(o,{currentX:e.touches[0].clientX,currentY:e.touches[0].clientY})},o=e=>{e.preventDefault();const t=c.getAllInstances();let o=!1;for(const r in t)if(t[r].touchState.pressed){o=!0;break}o&&_(e)},r=e=>{const t=c.getAllInstances();let o=!1;for(const r in t)if(t[r].touchState.pressed){o=!0;break}o&&_(e)};return document.addEventListener("mousemove",e),document.addEventListener("mouseup",o),document.addEventListener("touchmove",t),document.addEventListener("touchend",r),()=>{document.removeEventListener("mousemove",e),document.removeEventListener("mouseup",o),document.removeEventListener("touchmove",t),document.removeEventListener("touchend",r),Object.keys(L).forEach((e=>{cancelAnimationFrame(L[e])}))}}};let H=!1;const q=()=>H?(console.log("@Holo INIT: Events already initialized"),!1):(console.log("@Holo INIT: Initializing event handlers"),a.action([{id:u,debounce:300},{id:l},{id:S,log:!0}]),a.on(l,(e=>{const{virtual:t,dom:o}=e;if(!t.id)return void console.error("Holo carousel refresh error",t.id);o.container.setAttribute("style","");const{height:r,width:n}=(e=>{if(!e)return{width:0,height:0};const t={width:e.offsetWidth,height:e.offsetHeight},o=window.getComputedStyle(e,null);return t.width+=parseInt(o.marginLeft)+parseInt(o.marginRight),t.height+=parseInt(o.marginTop)+parseInt(o.marginBottom),t})(o.container.children[0]),i={...t};i.item.height=r,i.item.width=n,i.numberOfSlots=((e,t,o)=>{let r=Math.floor(e/t);return o&&r>o?o:r||1})(o.carousel.parentNode.clientWidth,i.item.width,i.item.max)||1;const s=i.numberOfSlots*i.item.width,l=o.carousel.clientWidth,u=o.container.children.length*i.item.width,m=o.container.clientWidth||u;i.carousel.width=s||l,i.carousel.height=i.item.height||o.carousel.clientHeight,i.container.width=i.io.orientation?o.carousel.width:m,i.container.height=o.container.clientHeight||i.item.height||0,i.endOfSlidePosition=i.io.orientation?-Math.abs(i.container.height-i.carousel.height):-Math.abs(i.container.width-i.carousel.width),c.updateVirtualDom(t.id,i),i.io.orientation?o.carousel.style.height=`${i.carousel.height}px`:o.carousel.style.width=`${i.carousel.width}px`,a.call(d,c.getVirtualDom(t.id))})),a.on(d,(e=>{if(!e.id)return{id:S,payload:"Holo snap error"};c.updateStyle(e.id,!0);const t=e.io.orientation?M(e):(e=>{const t={...e};return t.transformX=t.io.snap?w(t.transformX,t.item.width||0):t.transformX,t.transformY=0,t.transformX>=0?(t.transformX=0,t.endOfSlide=1):t.transformX<=t.endOfSlidePosition?(t.transformX=t.endOfSlidePosition,t.endOfSlide=-1):t.endOfSlide=0,t})(e);return c.updateVirtualDom(e.id,t),c.applyDomTransform(e.id),t})),a.on(f,O),a.on(g,C),a.on(p,$),a.on(h,T),a.on(y,I),a.on(v,x),a.on(b,A),a.on(E,k),a.on(D,R),a.on(m,(e=>console.log("shaking"))),a.on(u,(()=>{const e=c.getAllInstances();for(const t in e){const o=e[t];a.call(l,{virtual:o.virtualDom,dom:o.Dom})}})),a.on(S,(e=>{console.error(e)})),H=!0,!0),B=e=>{const t=c.getInstance(e);if(!t)return a.call(S,"@Holo: Cannot setup events handler for missing carousel: "+e),()=>{};const{virtualDom:o,Dom:r}=t;((e,t)=>{a.action([{id:p,payload:t,interval:5e3,repeat:!0},{id:g,payload:t,interval:t.io.duration,repeat:t.io.loop},{id:f,payload:t,interval:t.io.duration,repeat:t.io.loop},{id:d,payload:t},{id:y,payload:t},{id:h,payload:t},{id:b,payload:t},{id:v,payload:t},{id:E,payload:t}])})(0,o);const n=[];if(o.io.enabled){if(o.io.drag&&r.container){const t=t=>{t.preventDefault(),U._touchStart(t,e)},o=t=>{t.preventDefault(),U._touchStart(t,e)};r.container.addEventListener("mousedown",t),r.container.addEventListener("touchstart",o),n.push((()=>{r.container.removeEventListener("mousedown",t),r.container.removeEventListener("touchstart",o)}))}if(o.io.wheel&&r.carousel){const t=t=>{R(t,e)};r.carousel.addEventListener("wheel",t),n.push((()=>{r.carousel.removeEventListener("wheel",t)}))}o.io.animate&&a.call(p,o);const t=()=>{(e=>{const t=c.getInstance(e);t?a.call(l,{virtual:t.virtualDom,dom:t.Dom}):a.call(S,"Holo carousel refresh error: "+e)})(e)};r.container.addEventListener("resize",t),n.push((()=>{r.container.removeEventListener("resize",t)}))}return()=>{n.forEach((e=>e()))}},F=(e,t={})=>{if(!e)return a.call(S,"@Holo: Cannot create carousel from invalid element"),"";const o=e.id||`holo-${Date.now()}`,r=e.getElementsByClassName("holo-container")[0];return r?(c.registerInstance(o,{carousel:e,container:r},t),B(o),o):(a.call(S,"@Holo: holo-container not found: "+o),"")},P=new Set,V=e=>{console.log("@holo: auto activated:",e);const t=document.getElementsByClassName(e);if(t.length)for(let o=0;o<t.length;o++){const e=t[o];if(e.id&&P.has(e.id))continue;const r=F(e,{});r&&P.add(r)}else a.call(S,"@Holo: carousel structure not found")};let j=!1;const z=(()=>{const e=U.setupGlobalTouchListeners();return{TOUCH:U,INIT:(e="holo-carousel")=>{j?console.log("@Holo: Already initialized"):(console.log("%c HOLO - Initiating holo v2.3.4 ","background: #022d5f; color: white; display: block;"),q(),window.addEventListener("resize",(()=>{a.call(u)}),!1),window.onload=()=>{a.call(u)},V(e),j=!0)},BUILD:F,AUTO:V,carousel:(e,t={})=>{const o=c.getVirtualDom(e);if(!o)return{ok:!1,data:{}};const r={...o.io};for(const n in t)n in r&&(r[n]=t[n]);return c.updateVirtualDom(e,{io:r}),{ok:!0,data:r}},refresh:()=>{a.call(u)},dimensions:e=>c.getDimensions(e),cleanup:()=>{e(),window.removeEventListener("resize",(()=>a.call(u))),j=!1}}})();"undefined"!=typeof window&&(window.Holo=z),e.default=z,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
//# sourceMappingURL=holo.js.map
