!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).holo=e.holo||{})}(this,(function(e){"use strict";var t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function r(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var o,n={exports:{}};function i(){return o||(o=1,function(e){const r={reset:"[0m",magenta:"[35m",magentaBright:"[95m",red:"[31m",redBright:"[91m",green:"[32m",greenBright:"[92m",cyan:"[36m",cyanBright:"[96m",yellow:"[33m",yellowBright:"[93m",white:"[37m",whiteBright:"[97m",blue:"[34m",blueBright:"[94m",bgRed:"[41m",bgYellow:"[43m",bgBlue:"[44m",bold:"[1m",dim:"[2m",italic:"[3m",underline:"[4m"},o={DEBUG:["dim","cyan"],INFO:["blue","bold"],WARN:["yellowBright","bold"],ERROR:["redBright","bold"],SUCCESS:["greenBright","bold"]},n="undefined"!=typeof process&&process.versions&&process.versions.node,i="undefined"!=typeof window,a={DEBUG:0,INFO:1,WARN:2,ERROR:3,SUCCESS:1},s=(e,t,o)=>(s,c=!0,l=!1)=>{if(a[e]<a.DEBUG)return;const u=(d=e,m=s,`${c?`[${(new Date).toISOString()}]`:""} ${d}: ${m instanceof Error?`${m.message}\n${m.stack}`:"object"==typeof m?JSON.stringify(m,null,2):String(m)}`);var d,m;if(l||i){const t="ERROR"===e?"color: red; font-weight: bold":"WARN"===e?"color: orange; font-weight: bold":"SUCCESS"===e?"color: green; font-weight: bold":"INFO"===e?"color: blue":"color: gray";console[o](`%c${u}`,t)}else if(n){const e=t.reduce(((e,t)=>`${r[t]}${e}`),u);process.stdout.write(`${e}${r.reset}\n`)}},c={error:s("ERROR",o.ERROR,"error"),warn:s("WARN",o.WARN,"warn"),info:s("INFO",o.INFO,"log"),debug:s("DEBUG",o.DEBUG,"debug"),success:s("SUCCESS",o.SUCCESS,"log")},l=e=>{const t=new WeakMap;return(...r)=>{const o=r[0];return"object"==typeof o&&null!==o?(t.has(o)||t.set(o,e(...r)),t.get(o)):e(...r)}},u=(e,...t)=>t.reduce(((e,t)=>t(e)),e),d=(e,t)=>{if(Object.is(e,t))return!0;if("object"!=typeof e||"object"!=typeof t||null===e||null===t)return!1;if(Array.isArray(e)&&Array.isArray(t))return e.length===t.length&&e.every(((e,r)=>d(e,t[r])));const r=Object.keys(e),o=Object.keys(t);return r.length===o.length&&r.every((r=>d(e[r],t[r])))};"undefined"==typeof crypto&&(t.crypto={randomUUID:()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})),getRandomValues:e=>{if(null===e)return null;for(let t=0;t<e.length;t++)e[t]=Math.floor(256*Math.random());return e}});const m={RECUPERATION:6e4,MAX_TIMEOUT:Math.pow(2,31)-1},p="@cyre: System is offline",f="@cyre: System is online",g="@cyre: Welcome! How can I assist you?",h="Cannot add new channels: system is locked",y="Cannot add new subscribers: system is locked",v="Failed to prepare action: invalid configuration",b="Failed to execute action: runtime error",E="Action skipped: no payload changes detected",D="Failed to create channel: configuration error",S="Channel created successfully",k="Invalid channel data definition",w="Channel ID is required",I="Channel type is required",T="Invalid channel type specified",x="Invalid channel structure: check configuration",A="Invalid subscription parameters provided",O="Successfully subscribed to event",C="Invalid event handler provided",R="Subscription failed: check configuration",M="Call failed: system is offline",$="Call failed: invalid action ID",L="Call failed: action not responding",X="Dispatch failed: no subscriber found for this type",N="Q0.0U0.0A0.0N0.0T0.0U0.0M0 - I0.0N0.0C0.0E0.0P0.0T0.0I0.0O0.0N0.0S0-- ",Y={MIN:50,BASE:200,MAX:1e3,RECOVERY:2e3},H={HIGH:.9,CRITICAL:.95},U={MAX_CPU:80,MAX_MEMORY:85,MAX_EVENT_LOOP:50,MAX_CALL_RATE:1e3},_={system:{cpu:0,memory:0,eventLoop:0,isOverloaded:!1},breathing:{breathCount:0,currentRate:Y.BASE,lastBreath:Date.now(),stress:0,isRecuperating:!1,recuperationDepth:0,pattern:"NORMAL",nextBreathDue:Date.now()+Y.BASE},performance:{callsTotal:0,callsPerSecond:0,lastCallTimestamp:Date.now(),activeQueues:{critical:0,high:0,medium:0,low:0,background:0},queueDepth:0},stress:{cpu:0,memory:0,eventLoop:0,callRate:0,combined:0},lastUpdate:Date.now(),inRecuperation:!1,hibernating:!1,activeFormations:0,isLocked:!1},q=()=>{const e=new Map;return{get:t=>e.get(t),set:(t,r)=>{e.set(t,r),e.size>1e3&&Array.from(e.keys()).slice(0,e.size-1e3).forEach((t=>e.delete(t)))},forget:t=>e.delete(t),clear:()=>e.clear(),getAll:()=>Array.from(e.values()),size:()=>e.size}},B=q();B.set("quantum",_);const F=l(((e,t)=>{const r=Math.min(1,(e.cpu||0)/(.7*U.MAX_CPU)),o=Math.min(1,(e.memory||0)/(.7*U.MAX_MEMORY)),n=Math.min(1,(e.eventLoop||0)/(.7*U.MAX_EVENT_LOOP)),i=Math.min(1,(t.callsPerSecond||0)/(.7*U.MAX_CALL_RATE)),a=Math.max(r,o,n,i);return{cpu:r,memory:o,eventLoop:n,callRate:i,combined:Math.min(1,(r+o+n+i+2*a)/6)}})),P=e=>{if(e>=H.CRITICAL)return Y.RECOVERY;const t=Math.exp(e)-1;return Math.max(Y.MIN,Math.min(Y.MAX,Y.BASE*(1+t)))},V={inRecuperation:!1,hibernating:!1,activeFormations:0,recuperationInterval:void 0,isLocked:!1,lock:()=>{V.isLocked=!0,V.update({isLocked:!0})},isSystemLocked:()=>V.isLocked,get:()=>{const e=B.get("quantum");return Object.freeze({...e,inRecuperation:V.inRecuperation,hibernating:V.hibernating,activeFormations:V.activeFormations})},update:e=>{const t={...B.get("quantum"),...e,lastUpdate:Date.now(),inRecuperation:e.inRecuperation??V.inRecuperation,hibernating:e.hibernating??V.hibernating,activeFormations:e.activeFormations??V.activeFormations};return(e.system||e.performance)&&(t.stress=F(t.system,t.performance)),B.set("quantum",t),t},updateBreath:e=>{const t=B.get("quantum"),r=F(e,t.performance),o=Date.now(),n={...t.breathing,breathCount:t.breathing.breathCount+1,lastBreath:o,stress:r.combined,currentRate:P(r.combined),nextBreathDue:o+P(r.combined),isRecuperating:r.combined>H.HIGH,recuperationDepth:Math.min(1,r.combined),pattern:r.combined>H.HIGH?"RECOVERY":"NORMAL"};return V.update({system:e,breathing:n,stress:r,inRecuperation:n.isRecuperating})},recordCall:(e="medium")=>{const t=B.get("quantum"),r=Date.now(),o=r-t.performance.lastCallTimestamp>=1e3?1:t.performance.callsPerSecond+1,n={...t.performance,callsTotal:t.performance.callsTotal+1,callsPerSecond:o,lastCallTimestamp:r,activeQueues:{...t.performance.activeQueues,[e]:t.performance.activeQueues[e]+1},queueDepth:t.performance.queueDepth+1};return V.update({performance:n})},isHealthy:()=>{const e=B.get("quantum");return!e.breathing.isRecuperating&&e.stress.combined<H.HIGH},shouldAllowCall:e=>{const t=B.get("quantum");return t.breathing.isRecuperating?"critical"===e:t.stress.combined<H.HIGH||"critical"===e||"high"===e},reset:()=>{V.inRecuperation=!1,V.hibernating=!1,V.activeFormations=0,V.isLocked=!1,B.set("quantum",_)},forget:e=>{B.forget(e)}},j=q(),z=q(),G=q(),W=q(),Q=q(),Z=e=>{const t=Q.get(e);t?.intervalId&&clearInterval(t.intervalId),Q.forget(e),W.forget(e)},J=e=>{if(!e?.id)throw new Error("IO must have an id");try{const t={...e,timestamp:Date.now(),type:e.type||e.id};Z(e.id),j.set(e.id,t),Q.set(e.id,{lastExecutionTime:Date.now(),executionCount:0,errors:[]}),e.detectChanges&&W.set(e.id,e.payload),V.recordCall(e.priority?.level)}catch(t){throw c.error(`Failed to set IO: ${t instanceof Error?t.message:String(t)}`),t}},K=e=>j.get(e),ee=e=>(Z(e),j.forget(e)),te=()=>{j.getAll().forEach((e=>{e.id&&Z(e.id)})),W.clear(),Q.clear(),j.clear(),V.reset()},re=(e,t)=>{const r=W.get(e);return!d(t,r)},oe=e=>W.get(e),ne=e=>Q.get(e),ie=e=>{if(!e?.id||!e?.fn)throw new Error("Invalid subscriber format");z.set(e.id,e)},ae=e=>z.get(e),se=()=>z.clear(),ce=e=>{e.id&&G.set(e.id,e)},le=e=>G.get(e),ue=e=>{const t=G.get(e);return t?.timeoutId&&clearTimeout(t.timeoutId),G.forget(e)},de=()=>{G.getAll().forEach((e=>{e.timeoutId&&clearTimeout(e.timeoutId)})),G.clear()},me=()=>G.getAll(),pe=()=>G.getAll().filter((e=>"active"===e.status)),fe=e=>e.type&&e.id?{...e,ok:!0,status:"active"}:{...e,ok:!1,done:!1,status:"error",error:"Missing required fields: type or id"},ge=e=>e.detectChanges?re(e.id,e.payload)?e:{...e,ok:!0,done:!0,status:"skipped",skipped:!0,skipReason:E}:e,he=e=>{if(e.skipped||"error"===e.status)return e;try{const t=ae(e.id);if(!t)throw new Error("No subscriber found");const r=t.fn(e.payload);return r&&"object"==typeof r&&"id"in r?{...e,ok:!0,done:!0,status:"completed",intraLink:{id:r.id,payload:r.payload}}:{...e,ok:!0,done:!0,status:"completed"}}catch(t){return c.error(`${b}: ${e}, Error: ${t instanceof Error?t.message:String(t)}`),{...e,ok:!1,done:!1,status:"error",error:t instanceof Error?t.message:String(t)}}},ye=(e,t)=>{if(!e)return c.error(v),{id:"",type:"",ok:!1,done:!1,status:"error",error:v};try{return u((e=>{try{if(!e)throw new Error(v);return{...e,ok:!0,done:!1,status:"pending",timestamp:Date.now()}}catch(t){return{id:"",type:"",ok:!1,done:!1,status:"error",error:v}}})(e),fe,ge,he,(e=>{return"error"===e.status?e:((t=e).log&&("error"===t.status?c.error(t):(t.status,c.info(t))),t);var t}),(e=>{return"error"===e.status?e:((t=e).ok&&!t.skipped&&J({...t,timestamp:Date.now()}),t);var t}))}catch(r){return c.error(`Action processing failed: ${r}`),{...e,ok:!1,done:!1,status:"error",error:r instanceof Error?r.message:String(r)}}},ve=l((e=>e?e.id?e.type||e.id?e.type&&"string"!=typeof e.type?{isValid:!1,error:T}:{isValid:!0}:{isValid:!1,error:I}:{isValid:!1,error:w}:{isValid:!1,error:x})),be=(e,t)=>{try{if(!("object"==typeof(n=e)&&null!==n&&"id"in n&&"string"==typeof n.id&&n.id.length>0))return c.error(x),{ok:!1,message:x};const i=ve(e);if(!i.isValid)return c.error(i.error),{ok:!1,message:i.error};if(r=e,(o=t)&&!Object.entries(o).filter((([e,t])=>t(void 0).required)).map((([e])=>e)).every((e=>e in r)))return c.error(k),{ok:!1,message:k};const a=((e,t)=>{try{const r={...e},o=[];for(const[n,i]of Object.entries(e)){const e=t[n];if(!e){r[n]=i;continue}const a=e(i);if(!a.ok){if(a.required)return{ok:!1,message:`Required field '${n}' validation failed: ${a.message}`,payload:r};o.push(`${n}: ${a.message}`)}r[n]=a.payload}for(const[n,i]of Object.entries(t))if(i(void 0).required&&!(n in e))return{ok:!1,message:`Missing required field: ${n}`,payload:r};return o.length>0?{ok:!1,message:o.join("; "),payload:r}:{ok:!0,payload:r}}catch(r){const e=r instanceof Error?r.message:String(r);return c.error(`Data definition processing failed: ${e}`),{ok:!1,message:k}}})(e,t);if(!a.ok)return a;const s=(e=>{const t=Date.now();return{...e,type:e.type||e.id,timestamp:t,interval:e.interval||0,timeOfCreation:e.timeOfCreation||t}})({...a.payload,id:e.id});return c.success(S),{ok:!0,message:S,payload:s}}catch(i){const e=i instanceof Error?i.message:String(i);return c.error(`Channel processing failed: ${e}`),{ok:!1,message:D}}var r,o,n},Ee=(e,t)=>{try{const n=(o=t,(r=e)&&"string"==typeof r?"function"!=typeof o?{ok:!1,message:C,error:{code:"INVALID_HANDLER",message:"Event handler must be a function"}}:{ok:!0,message:O,subscriber:{id:r.trim(),fn:o}}:{ok:!1,message:T,error:{code:"INVALID_TYPE",message:`Type must be a non-empty string, received: ${r}`}});if(!n.ok||!n.subscriber)return c.error(n.error||n.message),{ok:!1,message:n.message};const{subscriber:i}=n;if(ae(i.id)){const e=`DUPLICATE LISTENER DETECTED: Channel "${i.id}" already has a listener attached!`;c.warn(e),"undefined"!=typeof console&&console.warn&&(console.warn(`🔥 ${e}`),console.warn("This may cause unexpected behavior if the previous listener is still active."),console.warn("Consider using cyre.forget() to remove previous listeners before adding new ones."))}return ie(i),c.info(`${O}: ${i.id}`),{ok:!0,message:`${O}: ${i.id}`}}catch(n){const e=n instanceof Error?n.message:String(n);return c.error(`Failed to add subscriber: ${e}`),{ok:!1,message:R}}var r,o},De=(e,t)=>V.isSystemLocked()?(c.error(y),{ok:!1,message:y}):Array.isArray(e)?(e=>{try{const t=e.map((e=>{if(!e.id||!e.fn)return c.error(`Invalid subscriber format: ${JSON.stringify(e)}`),!1;try{return ie(e),!0}catch(t){return c.error(`Failed to add subscriber ${e.id}: ${t}`),!1}})).filter(Boolean).length,r=e.length;return 0===t?{ok:!1,message:`Failed to add any subscribers out of ${r}`}:{ok:!0,message:`Successfully added ${t} out of ${r} subscribers`}}catch(t){const e=t instanceof Error?t.message:String(t);return c.error(`Batch subscription failed: ${e}`),{ok:!1,message:R}}})(e):"string"==typeof e&&t?Ee(e,t):(c.error(A),{ok:!1,message:A}),Se=async e=>{if(!e||!e.id)return;const t=performance.now(),r=le(e.id);var o;if(r&&r.isActive)try{await e.callback();const n=performance.now()-t;r.metrics.totalExecutions++,r.metrics.successfulExecutions++,r.metrics.lastExecutionTime=n,r.metrics.longestExecutionTime=Math.max(r.metrics.longestExecutionTime,n),r.metrics.shortestExecutionTime=Math.min(r.metrics.shortestExecutionTime,n),r.metrics.averageExecutionTime=(r.metrics.averageExecutionTime*(r.metrics.totalExecutions-1)+n)/r.metrics.totalExecutions,r.executionCount++,r.lastExecutionTime=Date.now(),"number"==typeof r.repeat&&r.repeat>0&&(r.repeat=r.repeat-1),ce(r),!0===(o=r.repeat)||o===1/0||"number"==typeof o&&o>0?we(r):ue(r.id)}catch(n){const t=le(e.id);t&&(t.metrics.failedExecutions++,ce(t)),c.error(`Timer execution failed: ${n}`)}},ke=e=>{if(!e||!e.id)return;const t=e.duration>m.RECUPERATION?m.RECUPERATION:Math.max(e.duration/10,1e3);let r,o=Date.now();const n=()=>{const i=le(e.id);if(!i||!i.isActive)return void clearTimeout(r);const a=Date.now(),s=V.get(),c=1+(s.stress?.combined||0);if(a-o>t||Math.abs(c-1)>.1){const e=i.originalDuration-i.executionCount*m.MAX_TIMEOUT;i.duration=Math.min(e,m.MAX_TIMEOUT)*c,i.nextExecutionTime=a+i.duration,ce(i),o=a}s.hibernating||"active"!==i.status||(r=setTimeout(n,t),i.recuperationInterval=r,ce(i))};return r=setTimeout(n,t),r},we=e=>{if(!e||!e.id)return;const t=V.get();if(t.hibernating)return;const r=Date.now(),o=1+(t.stress?.combined||0),n=le(e.id);if(!n||!n.isActive)return;if(n.executionCount>1e4)return c.error("Maximum execution count exceeded"),void ue(n.id);let i=n.duration*o;if(n.isInRecuperation){const e=n.originalDuration-n.executionCount*m.MAX_TIMEOUT;i=Math.min(e*o,m.MAX_TIMEOUT),n.duration=i,n.duration>m.RECUPERATION&&(n.recuperationInterval&&clearTimeout(n.recuperationInterval),n.recuperationInterval=ke(n)),e<=m.MAX_TIMEOUT&&(n.isInRecuperation=!1)}else n.duration=i;n.nextExecutionTime=r+n.duration,n.timeoutId&&clearTimeout(n.timeoutId);const a="undefined"!=typeof process&&"test"===process.env.NODE_ENV;n.timeoutId=a?setTimeout((()=>Se(n)),n.duration):n.duration<25?((e,t)=>{if("undefined"!=typeof process&&"test"===process.env.NODE_ENV)return setTimeout(e,t);const r=process.hrtime(),o=()=>{const[n,i]=process.hrtime(r),a=1e3*n+i/1e6;if(a>=t)e();else{const e=t-a;e<1?setImmediate(o):e<25?setTimeout(o,0):setTimeout(o,Math.floor(e/2))}};return setTimeout(o,0)})((()=>Se(n)),n.duration):setTimeout((()=>Se(n)),n.duration),ce(n)},Ie=(e,t,r,o=crypto.randomUUID())=>{try{const i=((e,t,r,o)=>{if(!e||"number"!=typeof t||"function"!=typeof r)throw new Error("Invalid formation parameters");const n=Date.now(),i=t>=m.MAX_TIMEOUT,a=V.get(),s=1+(a.stress?.combined||0),c={id:e,startTime:n,duration:i?m.MAX_TIMEOUT:t*s,originalDuration:t,callback:r,repeat:o,executionCount:0,lastExecutionTime:0,nextExecutionTime:n+(i?m.MAX_TIMEOUT:t*s),isInRecuperation:i,status:"active",isActive:!0,metrics:{totalExecutions:0,successfulExecutions:0,failedExecutions:0,averageExecutionTime:0,lastExecutionTime:0,longestExecutionTime:0,shortestExecutionTime:1/0,missedExecutions:0}};return i&&(c.recuperationInterval=ke(c)),c})(o,"number"==typeof e?e:24*((n=e).days||0)*60*60*1e3+60*(n.hours||0)*60*1e3+60*(n.minutes||0)*1e3+1e3*(n.seconds||0)+(n.milliseconds||0),t,r);return ce(i),we(i),{kind:"ok",value:i}}catch(i){return{kind:"error",error:i instanceof Error?i:new Error("Timer creation failed")}}var n},Te=e=>{const t=le(e);t?.timeoutId&&clearTimeout(t.timeoutId),t?.recuperationInterval&&clearTimeout(t.recuperationInterval),ue(e)},xe=e=>{if(e){const t=le(e);t&&(t.timeoutId&&clearTimeout(t.timeoutId),t.recuperationInterval&&clearTimeout(t.recuperationInterval),t.status="paused",t.isActive=!1,ce(t))}else me().forEach((e=>{e.timeoutId&&clearTimeout(e.timeoutId),e.recuperationInterval&&clearTimeout(e.recuperationInterval),e.status="paused",e.isActive=!1,ce(e)}))},Ae=e=>{if(!V.get().hibernating)if(e){const t=le(e);t&&"paused"===t.status&&(t.status="active",t.isActive=!0,ce(t),we(t))}else me().forEach((e=>{"paused"===e.status&&(e.status="active",e.isActive=!0,ce(e),we(e))}))},Oe=()=>{V.update({hibernating:!0}),me().forEach((e=>{e.timeoutId&&clearTimeout(e.timeoutId),e.recuperationInterval&&clearTimeout(e.recuperationInterval)})),de()},Ce={id:(e="")=>"string"==typeof e?{ok:!0,payload:e}:{ok:!1,payload:null,message:`action.id must be a string. Received '${e}'`,required:!0},type:(e="")=>"string"==typeof e?{ok:!0,payload:e}:{ok:!1,payload:null,message:`action.type must be a string. Received '${e}'`,required:!0},payload:(e=null)=>({ok:!0,payload:e}),interval:(e=0)=>Number.isInteger(e)?{ok:!0,payload:e}:{ok:!1,payload:0,message:`'${e}' invalid action.interval value`,required:!1},timeOfCreation:(e=0)=>Number.isInteger(e)?{ok:!0,payload:e}:{ok:!1,payload:0,message:`'${e}' invalid @cyre.call time of creation value`,required:!0},repeat:(e=0)=>"number"==typeof e||"boolean"==typeof e||e===1/0?{ok:!0,payload:e}:{ok:!1,payload:0,message:`'${e}' invalid action.repeat value. Expected number, boolean, or Infinity.`,required:!1},message:(e="")=>"string"==typeof e?{ok:!0,payload:e}:{ok:!1,payload:"",message:`action.message must be a string. Received '${e}'`,required:!1},group:(e="")=>"string"==typeof e?{ok:!0,payload:e}:{ok:!1,payload:null,message:`'${e}' invalid action.group value`,required:!1},callback:(e="")=>"string"==typeof e?{ok:!0,payload:e}:{ok:!1,payload:null,message:`'${e}' invalid action.callback value`,required:!1},log:(e=!1)=>"boolean"==typeof e?{ok:!0,payload:e}:{ok:!1,payload:!1,message:`'${e}' invalid action.log value`,required:!1},middleware:(e="")=>"string"==typeof e?{ok:!0,payload:e}:{ok:!1,payload:null,message:`'${e}' invalid action.middleware value`,required:!1},throttle:(e=0)=>Number.isInteger(e)?{ok:!0,payload:e}:{ok:!1,payload:100,message:`'${e}'  action.throttle value must be a number`,required:!1},debounce:(e=0)=>Number.isInteger(e)?{ok:!0,payload:e}:{ok:!1,payload:100,message:`'${e}'  action.debounce value must be a number`,required:!1},at:(e=0)=>({ok:!1,payload:e,message:`'${e}'  action.at is an experimental feature, not applied yet`,required:!1})},Re=function(e=crypto.randomUUID()){let t=!1;const r=async(e,t,r)=>{const o=e.repeat,i=Ie(t,(async()=>{V.isHealthy()&&await n({...e,timeOfCreation:performance.now(),payload:r??e.payload})}),o,e.id);return"error"===i.kind?{ok:!1,payload:null,message:i.error.message}:{ok:!0,payload:null,message:`Scheduled with breathing-adjusted interval: ${Math.round(t)}ms. First execution will occur after this interval.`}},o=async(e,t)=>{const r=e.priority?.level||"medium";if(!V.shouldAllowCall(r)){const{stress:e}=V.get();return{ok:!1,payload:null,message:`System under high stress (${(100*e.combined).toFixed(1)}%). Try later.`}}return i(e,t)},n=async e=>{if(!e?.type)throw new Error("Invalid IO object");try{const r=ae(e.type)||ae(e.id);if(!r){const t=`${X} ${e.type}`;return c.error(t),{ok:!1,payload:null,message:t}}const o=performance.now(),n=ye({...e},r.fn);if(e.log&&c.info({...n,executionTime:performance.now()-o,timestamp:Date.now()}),n?.intraLink)try{const{id:e,payload:t}=n.intraLink;await a(e,t)}catch(t){c.error(`Linked action error: ${t}`)}return{ok:!0,payload:n,message:g}}catch(t){const e=t instanceof Error?t.message:String(t);return c.error(`Dispatch error: ${e}`),{ok:!1,payload:null,message:`Dispatch error: ${e}`}}},i=async(e,t)=>{try{if(e.throttle){const t=Date.now()-(ne(e.id)?.lastExecutionTime||0);if(t<e.throttle)return{ok:!1,payload:null,message:`Throttled: ${e.throttle-t}ms remaining`}}if(e.debounce){e.debounceTimerId&&(Te(e.debounceTimerId),e.debounceTimerId=void 0);const r=`${e.id}-debounce-${Date.now()}`,o=t??e.payload,i=Ie(e.debounce,(async()=>{await n({...e,timeOfCreation:performance.now(),payload:o,debounceTimerId:void 0}),V.recordCall(e.priority?.level)}),!1,r);return"ok"===i.kind?(e.debounceTimerId=r,J(e),{ok:!0,payload:null,message:`Debounced: will execute after ${e.debounce}ms`}):{ok:!1,payload:null,message:`Failed to setup debounce: ${i.error.message}`}}const r=await n({...e,timeOfCreation:performance.now(),payload:t??e.payload});return V.recordCall(e.priority?.level),r}catch(r){return{ok:!1,payload:null,message:`Call failed: ${r instanceof Error?r.message:String(r)}`}}},a=async(e,n)=>{if(t)return{ok:!1,message:M,payload:null};if(!e?.trim())return{ok:!1,message:$,payload:null};const a=K(e.trim());return a?(async(e,t)=>{if(!e)return{ok:!1,payload:null,message:"Invalid action"};const{breathing:n,stress:a}=V.get();if(n.isRecuperating&&"critical"!==e.priority?.level)return{ok:!1,payload:null,message:`System recuperating (${(100*n.recuperationDepth).toFixed(1)}% depth). Try later.`};if(e.interval){const o=e.interval*(1+a.combined);return r(e,o,t)}return a.combined>=H.HIGH?o(e,t):i(e,t)})(a,n):{ok:!1,payload:null,message:`${L}: ${e}`}},s=()=>{if(!t)try{me().forEach((e=>{e.timeoutId&&clearTimeout(e.timeoutId)})),Oe(),se(),te(),V.reset(),t=!0,"undefined"!=typeof process&&process.exit&&process.exit(0)}catch(e){c.error(`Failed to shutdown gracefully: ${e}`),"undefined"!=typeof process&&process.exit&&process.exit(1)}};return"undefined"!=typeof window?window.addEventListener("beforeunload",s):(process.on("SIGINT",s),process.on("SIGTERM",s),process.on("uncaughtException",(e=>{console.error("Uncaught Exception:",e),s()}))),{initialize:()=>(t=!1,Ie(Y.BASE,(async()=>{const e=V.get();V.updateBreath({cpu:e.system.cpu,memory:e.system.memory,eventLoop:e.system.eventLoop,isOverloaded:e.system.isOverloaded})}),!0),Ae(),console.log("%c"+N,"background: rgb(151, 2, 151); color: white; display: block;"),{ok:!0,payload:200,message:g}),call:a,action:e=>{if(t)c.error(p);else if(V.isLocked)c.error(h);else try{if(Array.isArray(e))e.forEach((e=>{const t=be({...e,type:e.type||e.id},Ce);t.ok&&t.payload&&J(t.payload)}));else{const t=be({...e,type:e.type||e.id},Ce);t.ok&&t.payload&&J(t.payload)}}catch(r){c.error(`Action registration failed: ${r}`)}},on:De,shutdown:s,lock:()=>t?{ok:!1,message:M,payload:null}:(V.isLocked=!0,c.info("Cyre system locked - no new channels or subscribers can be added"),{ok:!0,message:"System locked successfully",payload:null}),status:()=>(t?c.info({ok:!0,message:p}):c.info({ok:!0,message:f}),t),forget:e=>t?(c.error(M),!1):(xe(e),ee(e)),get:e=>{if(!t)return K(e);c.error(M)},pause:e=>{if(t)return void c.error(M);xe(e);const r=me();if(e){const t=le(e);t&&ce({...t,status:"paused"})}else r.forEach((e=>{e&&ce({...e,status:"paused"})}))},resume:e=>{if(t)return void c.error(M);Ae(e);const r=me();if(e){const t=le(e);t&&ce({...t,status:"active"})}else r.forEach((e=>{e&&ce({...e,status:"active"})}))},hasChanged:(e,r)=>t?(c.error(M),!1):re(e,r),getPreviousPayload:e=>{if(!t)return oe(e);c.error(M)},getBreathingState:()=>V.get().breathing,getPerformanceState:()=>{const e=V.get();return{totalProcessingTime:0,totalCallTime:0,totalStress:e.stress.combined,stress:e.stress.combined}},getMetrics:e=>t?{hibernating:!0,activeFormations:0,inRecuperation:!1,breathing:V.get().breathing,formations:[]}:{hibernating:!1,activeFormations:pe().length,inRecuperation:!1,breathing:V.get().breathing,formations:me().filter((t=>t.id===e)).map((e=>({...e,breathingSync:1})))}}},Me=Re("quantum-inceptions");Me.initialize(),e.Cyre=Re,e.CyreLog=c,e.cyre=Me,e.default=Me,e.isEqual=d,e.memoize=l,e.pipe=u,e.tryCatch=async e=>{try{return{kind:"ok",value:await e()}}catch(t){return{kind:"error",error:t instanceof Error?t:new Error(String(t))}}},e.version="3.1.2",Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}(n.exports)),n.exports}const a=r(i()),s=e=>({id:e,enabled:1,wheel:0,controller:0,drag:1,swipe:1,snap:1,focus:1,animate:0,animateDirection:1,duration:0,loop:200,orientation:0,active:!0,onClick:!0,onDoubleClick:!0}),c=(()=>{let e={instances:{}};return{getInstance:t=>e.instances[t]?{...e.instances[t]}:void 0,getAllInstances:()=>({...e.instances}),getVirtualDom:t=>e.instances[t]?{...e.instances[t].virtualDom}:void 0,getDom:t=>e.instances[t]?{...e.instances[t].Dom}:void 0,getDimensions:t=>{const r=e.instances[t];if(r)return{car:{w:r.Dom.width||0,h:r.Dom.height||0},con:{w:r.virtualDom.container.width||0,h:r.virtualDom.container.height||0,x:r.virtualDom.transformX,y:r.virtualDom.transformY,z:r.virtualDom.transformZ}}},registerInstance:(t,r,o={})=>{const n=(e=>({id:e,carousel:{},container:{},io:s(e),title:null,description:null,duration:600,transitionTiming:"cubic-bezier(0.215, 0.61, 0.355, 1)",transformX:0,transformY:0,transformZ:0,numberOfSlots:0,endOfSlide:0,endOfSlidePosition:0,item:{max:8}}))(t);n.io={...n.io,...o};const i={id:t,virtualDom:n,Dom:{carousel:r.carousel,container:r.container},touchState:{pressed:!1,positionX:0,positionY:0,currentX:0,currentY:0,multiplier:1.482},updateStyle:!1};return e={...e,instances:{...e.instances,[t]:i}},{...i}},updateInstance:(t,r)=>{if(!e.instances[t])return;const o={...e.instances[t],...r,virtualDom:r.virtualDom?{...e.instances[t].virtualDom,...r.virtualDom}:e.instances[t].virtualDom,Dom:r.Dom?{...e.instances[t].Dom,...r.Dom}:e.instances[t].Dom,touchState:r.touchState?{...e.instances[t].touchState,...r.touchState}:e.instances[t].touchState};return e={...e,instances:{...e.instances,[t]:o}},{...o}},updateVirtualDom:(t,r)=>{if(!e.instances[t])return;const o={...e.instances[t].virtualDom,...r,carousel:r.carousel?{...e.instances[t].virtualDom.carousel,...r.carousel}:e.instances[t].virtualDom.carousel,container:r.container?{...e.instances[t].virtualDom.container,...r.container}:e.instances[t].virtualDom.container,io:r.io?{...e.instances[t].virtualDom.io,...r.io}:e.instances[t].virtualDom.io,item:r.item?{...e.instances[t].virtualDom.item,...r.item}:e.instances[t].virtualDom.item};return e={...e,instances:{...e.instances,[t]:{...e.instances[t],virtualDom:o}}},{...o}},updateDom:(t,r)=>{if(!e.instances[t])return;const o={...e.instances[t].Dom,...r};return e={...e,instances:{...e.instances,[t]:{...e.instances[t],Dom:o}}},{...o}},updateTouchState:(t,r)=>{if(!e.instances[t])return;const o={...e.instances[t].touchState,...r};return e={...e,instances:{...e.instances,[t]:{...e.instances[t],touchState:o}}},{...o}},updateStyle:(t,r)=>{e.instances[t]&&(e={...e,instances:{...e.instances,[t]:{...e.instances[t],updateStyle:r}}})},applyDomTransform:t=>{const r=e.instances[t];r&&(r.updateStyle?(r.Dom.container.style.transitionDuration=r.virtualDom.duration+"ms",r.Dom.container.style.transitionTimingFunction=r.virtualDom.transitionTiming):(r.Dom.container.style.transitionDuration="0ms",r.Dom.container.style.transitionTimingFunction="linear"),r.Dom.container.style.transform=`translate3d(${r.virtualDom.transformX}px, ${r.virtualDom.transformY}px, ${r.virtualDom.transformZ}px)`)},removeInstance:t=>{if(!e.instances[t])return!1;const{[t]:r,...o}=e.instances;return e={...e,instances:o},!0},hasInstance:t=>!!e.instances[t]}})(),l="refresh carousel",u="refresh screen",d="SNAP",m="SHAKE",p="Animate",f="AnimateForward",g="AnimateBackward",h="nxtSlide",y="prvSlide",v="firstSlide",b="lastSlide",E="activate",D="wheeler",S="holo-error",k=(e,t)=>Math.round(e/t)*t,w=([e,t])=>{const r=t.id,o={...t,transformX:-Math.abs(e.offsetLeft)};c.updateVirtualDom(r,o),a.call(d,o),e.classList.add("active")},I=e=>{const t=e.id;if(1===e.endOfSlide)return;const r={...e,transformX:e.transformX+(e.carousel.width||0),transformY:e.transformY+(e.carousel.height||0)};c.updateVirtualDom(t,r),a.call(d,r)},T=e=>{const t=e.id;if(-1===e.endOfSlide)return;const r={...e,transformX:e.transformX-(e.carousel.width||0),transformY:e.transformY-(e.carousel.height||0)};c.updateVirtualDom(t,r),a.call(d,r)},x=e=>{const t=e.id,r={...e,transformX:0,transformY:0,endOfSlide:1};c.updateVirtualDom(t,r),a.call(d,r)},A=e=>{const t=e.id,r={...e,transformX:e.endOfSlidePosition,transformY:e.endOfSlidePosition,endOfSlide:-1};c.updateVirtualDom(t,r),a.call(d,r)},O=e=>-1===e.endOfSlide?a.call(v,e):a.call(h,e),C=e=>1===e.endOfSlide?a.call(b,e):a.call(y,e),R=e=>{a.call(f)},M=(e,t)=>{e.preventDefault();const r=c.getVirtualDom(t);r&&(e.deltaY<0?a.call(y,r):e.deltaY>0&&a.call(h,r))},$=e=>{const t={...e};return t.transformY=t.io.snap?k(t.transformY,t.item.height||0):t.transformY,t.transformX=0,t.transformY>=0?(t.transformY=0,t.endOfSlide=1):t.transformY<=t.endOfSlidePosition?(t.transformY=t.endOfSlidePosition,t.endOfSlide=-1):t.endOfSlide=0,t},L={},X=e=>{const t=c.getInstance(e);if(!t||!t.touchState.pressed)return;const{touchState:r,virtualDom:o}=t,n=r.positionX-r.currentX,i=(e=>{const t={...e};return t.transformY=0,t.transformX>=0?t.transformX=0:t.transformX<=t.endOfSlidePosition&&(t.transformX=t.endOfSlidePosition),t})({...o,transformX:(r.snapShotWidth||0)-n*r.multiplier});c.updateVirtualDom(e,i),c.updateTouchState(e,{distance:n}),c.applyDomTransform(e),t.touchState.pressed&&(L[e]=requestAnimationFrame((()=>X(e))))},N=e=>{const t=c.getInstance(e);if(!t||!t.touchState.pressed)return;const{touchState:r,virtualDom:o}=t,n=r.positionY-r.currentY,i=(r.snapShotHeight||0)-n*r.multiplier,a=$({...o,transformY:i});c.updateVirtualDom(e,a),c.updateTouchState(e,{distance:n}),c.applyDomTransform(e),t.touchState.pressed&&(L[e]=requestAnimationFrame((()=>N(e))))},Y=e=>{const t=c.getAllInstances();let r=null;for(const a in t)if(t[a].touchState.pressed){r=a;break}if(!r)return;const o=c.getInstance(r);if(!o)return;e.preventDefault(),L[r]&&(cancelAnimationFrame(L[r]),delete L[r]),c.updateTouchState(r,{pressed:!1});const{touchState:n,virtualDom:i}=o,s=performance.now()-(n.TouchStartTimeStamp||0),l=((e,t)=>e/t)(n.distance||0,s);l>1.2?a.call(h,i):l<-1.2?a.call(y,i):(e=>e<250)(s)?H(e,r):a.call(d,i)},H=(e,t)=>{const r=e.target.closest("li.holo");if(!r)return a.call(S,"_focus holo item not found");const o=c.getInstance(t);return o?(o.touchState.targetHoloComponent&&o.touchState.targetHoloComponent.classList.remove("active"),c.updateTouchState(t,{targetHoloComponent:r}),a.call(E,[r,o.virtualDom]),!0):a.call(S,"_focus holo instance not found")},U={_touchStart:(e,t)=>{if(!t)return void console.error("Holo touch: missing carousel ID");const r=c.getInstance(t);if(!r)return;L[t]&&(cancelAnimationFrame(L[t]),delete L[t]);const o="touches"in e?e.touches[0].clientX:e.clientX,n="touches"in e?e.touches[0].clientY:e.clientY,i={pressed:!0,positionX:o,positionY:n,currentX:o,currentY:n,TouchStartTimeStamp:performance.now(),multiplier:1.482,snapShotWidth:r.virtualDom.transformX||0,snapShotHeight:r.virtualDom.transformY||0};c.updateTouchState(t,i),c.updateStyle(t,!1),r.virtualDom.io.orientation?(N(t),e.preventDefault()):(X(t),e.preventDefault())},_touchEnd:Y,_dragScrollHorizontal:X,_dragScrollVertical:N,_focus:H,setupGlobalTouchListeners:()=>{const e=e=>{const t=c.getAllInstances();for(const r in t)t[r].touchState.pressed&&c.updateTouchState(r,{currentX:e.clientX,currentY:e.clientY})},t=e=>{const t=c.getAllInstances();for(const r in t)t[r].touchState.pressed&&c.updateTouchState(r,{currentX:e.touches[0].clientX,currentY:e.touches[0].clientY})},r=e=>{e.preventDefault();const t=c.getAllInstances();let r=!1;for(const o in t)if(t[o].touchState.pressed){r=!0;break}r&&Y(e)},o=e=>{const t=c.getAllInstances();let r=!1;for(const o in t)if(t[o].touchState.pressed){r=!0;break}r&&Y(e)};return document.addEventListener("mousemove",e),document.addEventListener("mouseup",r),document.addEventListener("touchmove",t),document.addEventListener("touchend",o),()=>{document.removeEventListener("mousemove",e),document.removeEventListener("mouseup",r),document.removeEventListener("touchmove",t),document.removeEventListener("touchend",o),Object.keys(L).forEach((e=>{cancelAnimationFrame(L[e])}))}}};let _=!1;const q=()=>_?(console.log("@Holo: Events already initialized"),!1):(console.log("@Holo: Initializing event handlers"),a.action([{id:u,debounce:300},{id:l},{id:S,log:!0}]),a.on(l,(e=>{const{virtual:t,shadow:r}=e;if(!t.id)return void console.error("Holo carousel refresh error",t.id);r.container.setAttribute("style","");const{height:o,width:n}=(e=>{if(!e)return{width:0,height:0};const t={width:e.offsetWidth,height:e.offsetHeight},r=window.getComputedStyle(e,null);return t.width+=parseInt(r.marginLeft)+parseInt(r.marginRight),t.height+=parseInt(r.marginTop)+parseInt(r.marginBottom),t})(r.container.children[0]),i={...t};i.item.height=o,i.item.width=n,i.numberOfSlots=((e,t,r)=>{let o=Math.floor(e/t);return r&&o>r?r:o||1})(r.carousel.parentNode.clientWidth,i.item.width,i.item.max)||1;const s=i.numberOfSlots*i.item.width,l=r.carousel.clientWidth,u=r.container.children.length*i.item.width,m=r.container.clientWidth||u;i.carousel.width=s||l,i.carousel.height=i.item.height||r.carousel.clientHeight,i.container.width=i.io.orientation?r.carousel.width:m,i.container.height=r.container.clientHeight||i.item.height||0,i.endOfSlidePosition=i.io.orientation?-Math.abs(i.container.height-i.carousel.height):-Math.abs(i.container.width-i.carousel.width),c.updateVirtualDom(t.id,i),a.call(d,i)})),a.on(d,(e=>{if(!e.id)return{id:S,payload:"Holo snap error"};c.updateStyle(e.id,!0);const t=e.io.orientation?$(e):(e=>{const t={...e};return t.transformX=t.io.snap?k(t.transformX,t.item.width||0):t.transformX,t.transformY=0,t.transformX>=0?(t.transformX=0,t.endOfSlide=1):t.transformX<=t.endOfSlidePosition?(t.transformX=t.endOfSlidePosition,t.endOfSlide=-1):t.endOfSlide=0,t})(e);return c.updateVirtualDom(e.id,t),c.applyDomTransform(e.id),t})),a.on(f,O),a.on(g,C),a.on(p,R),a.on(h,T),a.on(y,I),a.on(v,x),a.on(b,A),a.on(E,w),a.on(D,M),a.on(m,(e=>console.log("shaking"))),a.on(u,(()=>{const e=c.getAllInstances();for(const t in e){const r=e[t];a.call(l,{virtual:r.virtualDom,shadow:r.Dom})}})),_=!0,!0),B=e=>{const t=c.getInstance(e);t?a.call(l,{virtual:t.virtualDom,shadow:t.Dom}):console.error("Holo carousel refresh error:",e)},F=e=>{const t=c.getInstance(e);if(!t)return console.error("@Holo: Cannot setup events for missing carousel:",e),()=>{};const{virtualDom:r,Dom:o}=t;((e,t)=>{a.action([{id:p,payload:t,interval:5e3,repeat:!0},{id:g,payload:t,interval:t.io.duration,repeat:t.io.loop},{id:f,payload:t,interval:t.io.duration,repeat:t.io.loop},{id:d,payload:t},{id:y,payload:t},{id:h,payload:t},{id:b,payload:t},{id:v,payload:t},{id:E,payload:t}])})(0,r);const n=[];if(r.io.enabled){if(r.io.drag&&o.container){const t=t=>{t.preventDefault(),U._touchStart(t,e)},r=t=>{t.preventDefault(),U._touchStart(t,e)};o.container.addEventListener("mousedown",t),o.container.addEventListener("touchstart",r),n.push((()=>{o.container.removeEventListener("mousedown",t),o.container.removeEventListener("touchstart",r)}))}if(r.io.wheel&&o.carousel){const t=t=>{M(t,e)};o.carousel.addEventListener("wheel",t),n.push((()=>{o.carousel.removeEventListener("wheel",t)}))}r.io.animate&&a.call(p,r);const t=()=>{B(e)};o.container.addEventListener("resize",t),n.push((()=>{o.container.removeEventListener("resize",t)}))}return B(e),()=>{n.forEach((e=>e()))}},P=(e,t={})=>{if(!e)return console.error("@Holo: Cannot create carousel from invalid element"),"";const r=e.id||`holo-${Date.now()}`,o=e.getElementsByClassName("holo-container")[0];return o?(c.registerInstance(r,{carousel:e,container:o},t),F(r),r):(console.error("@Holo: holo-container not found:",r),"")},V=e=>{console.log("@holo: auto activated:",e);const t=document.getElementsByClassName(e);if(t.length)for(let r=0;r<t.length;r++){const e=t[r];P(e,{})}else console.log("@Holo: carousel structure not found")};let j=!1;const z=(()=>{const e=U.setupGlobalTouchListeners();return{TOUCH:U,INIT:(e="holo-carousel")=>{j?console.log("@Holo: Already initialized"):(console.log("%c HOLO - Initiating holo v2.3.4 ","background: #022d5f; color: white; display: block;"),q(),window.addEventListener("resize",(()=>{a.call(u)}),!1),V(e),j=!0)},BUILD:P,AUTO:V,carousel:(e,t={})=>{const r=c.getVirtualDom(e);if(!r)return{ok:!1,data:{}};const o={...r.io};for(const n in t)n in o&&(o[n]=t[n]);return c.updateVirtualDom(e,{io:o}),{ok:!0,data:o}},refresh:()=>{a.call(u)},dimensions:e=>c.getDimensions(e),cleanup:()=>{e(),window.removeEventListener("resize",(()=>a.call(u))),j=!1}}})();"undefined"!=typeof window&&(window.Holo=z),e.default=z,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
//# sourceMappingURL=holo.js.map
